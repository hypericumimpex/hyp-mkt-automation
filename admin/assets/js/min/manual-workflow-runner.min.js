jQuery(function(r){var n={},o={},e={update:function(e,t){e.find("> .automatewoo-manual-runner-progress-bar__fill").stop().animate({width:t+"%"},0===t?0:400)}};n.stopped=!0,n.batchSize=10,n.ruleGroupProgress=[],n.$matchesTable=r(".automatewoo-manual-runner__matches-table"),n.$resultsContainer=r(".automatewoo-manual-runner__matches-results"),n.$startButton=r(".automatewoo-manual-runner__start-finder-btn"),n.$stopButton=r(".automatewoo-manual-runner__stop-finder-btn"),n.$step2=r(".automatewoo-manual-runner__step-2"),n.$step3=r(".automatewoo-manual-runner__step-3"),n.$workflowField=r(".automatewoo-manual-runner__workflow_field"),n.$noMatchesMessage=r(".automatewoo-manual-runner__no-matches-message"),n.reset=function(){n.ruleGroupProgress=[],n.stopped=!0,n.$resultsContainer.empty(),n.updateResultsCount(),n.updateProgressBar(),n.$step3.hide(),n.$matchesTable.hide(),n.$noMatchesMessage.hide(),o.reset()},n.start=function(){n.reset(),n.$stopButton.show(),n.$matchesTable.show(),n.stopped=!1,n.$startButton.prop("disabled",!0),n.getWorkflowQuickFilterInfo(function(e){for(var t in e.possible_result_counts)n.ruleGroupProgress.push({group_number:t,offset:0,total:e.possible_result_counts[t],complete:!1});n.findSet()})},n.getCurrentRuleGroupIndex=function(){for(var e=0;e<n.ruleGroupProgress.length;e++){if(!n.ruleGroupProgress[e].complete)return e}return!1},n.findSet=function(){if(!n.stopped&&0!==n.ruleGroupProgress.length){var e=n.getCurrentRuleGroupIndex();if(!1!==e){var t=n.ruleGroupProgress[e],o={action:"aw_manual_workflow_runner_find_matches",workflow_id:n.$workflowField.val(),offset:t.offset,batch_size:n.batchSize,rule_group:t.group_number};r.post(ajaxurl,o,n.findSetResponse)}else n.complete()}},n.findSetResponse=function(e){var t=n.getCurrentRuleGroupIndex(),o=n.ruleGroupProgress[t];if(e.success&&!n.stopped&&!1!==o){for(var r in e.data.results)if(!n.resultExists(r)){var u=e.data.results[r];n.$resultsContainer.prepend(u)}o.offset+=n.batchSize,o.offset>=o.total&&(o.complete=!0),n.ruleGroupProgress[t]=o,n.updateResultsCount(),n.updateProgressBar(),n.findSet()}},n.complete=function(){n.stop(),0<n.getResultsCount()?n.$step3.show():n.$noMatchesMessage.show()},n.stop=function(){n.$startButton.removeProp("disabled"),n.$stopButton.hide(),n.stopped=!0},n.getResultsCount=function(){return n.$resultsContainer.find("div").length},n.updateResultsCount=function(){r(".automatewoo-manual-runner__matches-count").text(n.getResultsCount())},n.updateProgressBar=function(){e.update(r(".automatewoo-manual-runner__matches-progress-bar"),n.getCurrentProgress())},n.getCurrentProgress=function(){for(var e=0,t=0,o=0;o<n.ruleGroupProgress.length;o++){var r=n.ruleGroupProgress[o];e+=r.total,t+=r.complete?r.total:r.offset}if(0===t||0===e)return 0;var u=t/e;return 100<(u=Math.round(100*u))?100:u},n.getWorkflowQuickFilterInfo=function(t){var e={action:"aw_manual_workflow_runner_get_quick_filter_info",workflow_id:n.$workflowField.val()};r.post(ajaxurl,e,function(e){console.log(e),e.success&&t&&t(e.data)})},n.resultExists=function(e){return n.$resultsContainer.find('[data-item-id="'+e+'"]').length},n.$startButton.click(function(){n.start()}),n.$stopButton.click(function(){n.stop()}),n.$workflowField.change(function(){n.reset(),o.reset()}),o.$startButton=r(".automatewoo-manual-runner__run-now"),o.itemsToAddToQueue=[],o.itemsToAddCount=0,o.$log_adding=r(".automatewoo-step-3-log__adding"),o.$log_added=r(".automatewoo-step-3-log__added"),o.reset=function(){o.$startButton.prop("disabled",!1),o.itemsToAddCount=0,o.itemsToAddToQueue=[],o.$log_added.hide(),o.$log_adding.hide(),o.updateProgressBar()},o.start=function(){o.$startButton.prop("disabled",!0),r(".automatewoo-manual-runner__matches-result").each(function(){o.itemsToAddToQueue.push(r(this).data("item-id"))}),o.itemsToAddCount=o.itemsToAddToQueue.length,o.startAddToQueue()},o.startAddToQueue=function(){o.addBatchToQueue(),o.$log_adding.show()},o.addBatchToQueue=function(){0===o.itemsToAddToQueue.length&&o.completedAddingToQueue();var e=o.itemsToAddToQueue.splice(0,10);o.updateProgressBar();var t={action:"aw_manual_workflow_runner_add_to_queue",workflow_id:n.$workflowField.val(),batch:e};r.post(ajaxurl,t,function(e){e.success&&(r(".automatewoo-step-3-log__view-queue-url").prop("href",e.data.queue_url),o.addBatchToQueue())})},o.getCurrentProgress=function(){if(0===o.itemsToAddCount)return 0;var e=(o.itemsToAddCount-o.itemsToAddToQueue.length)/o.itemsToAddCount;return 100<(e=Math.round(100*e))?100:e},o.updateProgressBar=function(){e.update(r(".automatewoo-manual-runner__queue-progress-bar"),o.getCurrentProgress())},o.completedAddingToQueue=function(){o.$log_added.show()},o.$startButton.click(function(){o.start()})});
//# sourceMappingURL=manual-workflow-runner.min.js.map
